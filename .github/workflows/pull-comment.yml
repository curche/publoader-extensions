name: "Comment New Titles to PR"

on:
  pull_request:
    branches: [ "jq-comm-title-comment" ]
    paths:
      - 'src/mangaplus/manga_id_map.json'
    types: [opened, synchronize]

jobs:
  diff:
    name: Extract {UU,}IDs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Fetch branches
        run: |
          git fetch origin pull/${{ github.event.number }}/head:NEW_BRANCH
          git fetch origin ${GITHUB_BASE_REF}:CURRENT_BRANCH
      - name: Git Show
        run: |
          git -P show NEW_BRANCH:src/mangaplus/manga_id_map.json >new
          git -P show CURRENT_BRANCH:src/mangaplus/manga_id_map.json >current
      - name: jq to plus
        run: |
          jq -r $(echo '.[].[]') new | sort -o new.mangaplus
          jq -r $(echo '.[].[]') current | sort -o current.mangaplus
      - name: jq to dex
        run: |
          what=". | keys[]"
          cat new | jq --raw-output "$what" | sort -o new.mangadex
          cat current | jq --raw-output "$what" | sort -o current.mangadex
      - name: comm
        run: |
          comm -13 current.mangadex new.mangadex | tee mangadex.comm
          comm -13 current.mangaplus new.mangaplus | tee mangaplus.comm
      - id: result
        run: |
          {
            echo 'dex_comm<<EOF'
            cat mangadex.comm
            echo EOF
          } >> "$GITHUB_OUTPUT"
          {
            echo 'plus_comm<<EOF'
            cat mangaplus.comm
            echo EOF
          } >> "$GITHUB_OUTPUT"

    outputs:
      dex: ${{ steps.result.outputs.dex_comm }}
      plus: ${{ steps.result.outputs.plus_comm }}

  comment-on-pr:
    name: Comment to PR
    runs-on: ubuntu-latest
    needs: [diff]
    steps:
      - name: Create file
        run: |
          {
            echo 'dex_comm<<EOF'
            ${{ needs.diff.outputs.dex }}
            echo EOF
          } >> "$GITHUB_ENV"
          {
            echo 'dex_comm<<EOF'
            ${{ needs.diff.outputs.plus }}
            echo EOF
          } >> "$GITHUB_ENV"
          {
            echo 'PR_COMMENT_OUTPUT<<EOF'
            echo "New Dex UUID(s): "
            for uuid in $dex_comm; do
              echo "[$uuid](https://mangadex.org/title/$uuid) "
            done
            echo ""
            echo "New M+ ID(s): \n"
            for mpid in $plus_comm; do
              echo "[$mpid](https://mangaplus.shueisha.co.jp/titles/$mpid) "
            done
            echo EOF
          } >> "$GITHUB_ENV"
          echo $PR_COMMENT_OUTPUT
      - name: PR comment with file
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: ${{ env.PR_COMMENT_OUTPUT }}
